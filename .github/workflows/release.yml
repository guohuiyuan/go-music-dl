name: Release (CLI & Desktop)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ===================================================
  # 1. Goreleaser (负责 Linux/Windows/macOS 的 CLI 构建)
  # ===================================================
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v5
        with:
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===================================================
  # 2. Windows 桌面端构建
  # ===================================================
  build-windows-desktop:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            arch_name: amd64
          - target: i686-pc-windows-msvc
            arch_name: 386
          - target: aarch64-pc-windows-msvc
            arch_name: arm64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # [新增] Rust 编译缓存 (加速后续构建)
      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: desktop

      # 编译 Go 后端
      - name: Build Go Backend
        run: |
          go build -ldflags "-s -w" -o music-dl.exe ./cmd/music-dl
        env:
          CGO_ENABLED: 0
          GOOS: windows
          GOARCH: ${{ matrix.arch_name }}

      # 编译 Rust 桌面端
      - name: Build Rust Desktop
        run: |
          cd desktop
          cargo build --release --target ${{ matrix.target }}

      # 打包桌面端 Zip
      - name: Package Desktop
        shell: powershell
        run: |
          mkdir dist
          copy desktop/target/${{ matrix.target }}/release/go-music-dl-desktop.exe dist/music-dl-desktop.exe
          Compress-Archive -Path dist/* -DestinationPath go-music-dl-desktop-windows-${{ matrix.arch_name }}.zip

      - name: Upload Artifacts
        uses: softprops/action-gh-release@v1
        with:
          files: go-music-dl-desktop-windows-${{ matrix.arch_name }}.zip

  # ===================================================
  # 3. macOS 桌面端构建 (CLI 已移交给 Goreleaser)
  # ===================================================
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - target: x86_64-apple-darwin
            arch_name: amd64
          - target: aarch64-apple-darwin
            arch_name: arm64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # [新增] Rust 编译缓存
      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: desktop

      - name: Install Packaging Tools
        run: brew install create-dmg

      # 编译 Go 后端
      - name: Build Go Backend
        run: |
          go build -ldflags "-s -w" -o music-dl ./cmd/music-dl
        env:
          CGO_ENABLED: 0
          GOOS: darwin
          GOARCH: ${{ matrix.arch_name }}

      # 编译 Rust 桌面端
      - name: Build Rust Desktop
        run: |
          cd desktop
          cargo build --release --target ${{ matrix.target }}

      # 打包桌面端 DMG & PKG
      - name: Create DMG & PKG
        run: |
          # 1. 创建 .app 目录结构
          mkdir -p bundle/MusicDL.app/Contents/MacOS
          mkdir -p bundle/MusicDL.app/Contents/Resources
          
          # 2. 复制二进制文件
          cp desktop/target/${{ matrix.target }}/release/go-music-dl-desktop bundle/MusicDL.app/Contents/MacOS/MusicDL
          chmod +x bundle/MusicDL.app/Contents/MacOS/MusicDL
          
          # 3. 自动生成 macOS 所需的 .icns 图标
          mkdir MusicDL.iconset
          sips -z 16 16     desktop/icon.png --out MusicDL.iconset/icon_16x16.png
          sips -z 32 32     desktop/icon.png --out MusicDL.iconset/icon_16x16@2x.png
          sips -z 32 32     desktop/icon.png --out MusicDL.iconset/icon_32x32.png
          sips -z 64 64     desktop/icon.png --out MusicDL.iconset/icon_32x32@2x.png
          sips -z 128 128   desktop/icon.png --out MusicDL.iconset/icon_128x128.png
          sips -z 256 256   desktop/icon.png --out MusicDL.iconset/icon_128x128@2x.png
          sips -z 256 256   desktop/icon.png --out MusicDL.iconset/icon_256x256.png
          sips -z 512 512   desktop/icon.png --out MusicDL.iconset/icon_256x256@2x.png
          sips -z 512 512   desktop/icon.png --out MusicDL.iconset/icon_512x512.png
          iconutil -c icns MusicDL.iconset
          
          # 4. 将生成的 .icns 放入 Resources 目录
          cp MusicDL.icns bundle/MusicDL.app/Contents/Resources/
          
          # 5. 生成 Info.plist (增加 CFBundleIconFile 字段)
          echo '<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>CFBundleExecutable</key><string>MusicDL</string><key>CFBundleIdentifier</key><string>com.guohuiyuan.musicdl</string><key>CFBundleName</key><string>MusicDL</string><key>CFBundleIconFile</key><string>MusicDL</string><key>CFBundlePackageType</key><string>APPL</string><key>CFBundleShortVersionString</key><string>0.1.0</string><key>LSUIElement</key><true/></dict></plist>' > bundle/MusicDL.app/Contents/Info.plist

          # 5.1 对 .app 进行 Ad-hoc 签名，避免 Gatekeeper 在 Apple Silicon 上报“已损坏”错误
          # 使用 Ad-hoc 签名（占位符证书 '-'），足以让二进制可执行并通过基本检查
          codesign --force --deep --sign - bundle/MusicDL.app || true

          # 6. 生成安装包
          create-dmg --volname "MusicDL Installer" --window-pos 200 120 --window-size 800 400 --app-drop-link 600 185 "go-music-dl-desktop-macos-${{ matrix.arch_name }}.dmg" "bundle/MusicDL.app"
          productbuild --component bundle/MusicDL.app /Applications "go-music-dl-desktop-macos-${{ matrix.arch_name }}.pkg"

      - name: Upload Artifacts
        uses: softprops/action-gh-release@v1
        with:
          files: |
            go-music-dl-desktop-macos-*.dmg
            go-music-dl-desktop-macos-*.pkg

  # ===================================================
  # 4. Linux 桌面端构建
  # ===================================================
  build-linux-desktop:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      - uses: dtolnay/rust-toolchain@stable

      # [新增] Rust 编译缓存
      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: desktop

      - name: Install Dependencies
        run: |
          sudo apt-get update
          # 包含 libfuse2 (AppImage) 和 imagemagick (图标)
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev imagemagick libfuse2
          cargo install cargo-deb
          cargo install cargo-generate-rpm

      - name: Build Go Backend
        run: go build -ldflags "-s -w" -o music-dl ./cmd/music-dl
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: amd64

      - name: Build Rust Desktop
        run: |
          cd desktop
          cargo build --release

      - name: Package Desktop (Deb, RPM, AppImage)
        run: |
          cd desktop
          cargo deb --no-build --output ../go-music-dl-desktop-linux-amd64.deb
          
          cargo generate-rpm
          mv target/generate-rpm/*.rpm ../go-music-dl-desktop-linux-amd64.rpm
          
          cd ..
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps/
          mkdir -p AppDir/usr/share/applications/
          cp desktop/target/release/go-music-dl-desktop AppDir/usr/bin/music-dl-desktop
          convert desktop/icon.png -resize 256x256! AppDir/usr/share/icons/hicolor/256x256/apps/music-dl.png
          echo -e "[Desktop Entry]\nType=Application\nName=MusicDL\nExec=music-dl-desktop\nIcon=music-dl\nCategories=AudioVideo;" > AppDir/usr/share/applications/music-dl.desktop
          
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage --icon-file AppDir/usr/share/icons/hicolor/256x256/apps/music-dl.png --desktop-file AppDir/usr/share/applications/music-dl.desktop
          mv MusicDL*.AppImage go-music-dl-desktop-linux-amd64.AppImage

      - name: Upload Desktop Artifacts
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.deb
            *.rpm
            go-music-dl-desktop-linux-amd64.AppImage