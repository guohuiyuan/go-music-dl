<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Music Hub - ËÅöÂêàÊêúÁ¥¢</title>
    <link rel="icon" href="/icon.png" type="image/png">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css">

    <style>
        :root {
            --primary-color: #667eea;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-color: #f5f7fa;
            --card-bg: #ffffff;
            --text-main: #2d3748;
            --text-sub: #718096;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --shadow-active: 0 10px 15px -3px rgba(102, 126, 234, 0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #eef2f5;
            /* Âä®ÊÄÅËÉåÊôØÁ∫πÁêÜ */
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-size: 100% 600px;
            background-repeat: no-repeat;
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px 120px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container { width: 100%; max-width: 900px; z-index: 1; }

        /* --- ÊêúÁ¥¢Âå∫Âüü --- */
        .search-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.5);
        }

        h1 {
            text-align: center; margin: 0 0 25px 0;
            font-size: 2.2rem; font-weight: 800; letter-spacing: -1px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* ÊêúÁ¥¢Ê°Ü */
        .input-group { display: flex; gap: 10px; margin-bottom: 25px; }
        
        input[type="text"] {
            flex: 1; padding: 14px 24px;
            border: 2px solid #e2e8f0; border-radius: 50px;
            font-size: 16px; outline: none; transition: all 0.3s;
            background: #f8fafc;
        }
        input[type="text"]:focus {
            border-color: var(--primary-color); background: #fff;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
        }

        .search-btn {
            padding: 0 32px; border: none; border-radius: 50px;
            background: var(--primary-gradient); color: white;
            font-size: 16px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .search-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4); }

        /* --- ÊêúÁ¥¢Ê∫êÈÄâÊã©Âô® (Âç°ÁâáÂºè) --- */
        .source-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #edf2f7;
        }
        .source-title { font-weight: 700; color: var(--text-sub); font-size: 0.9rem; }
        
        .ctrl-btn {
            background: none; border: none; color: var(--text-sub);
            font-size: 12px; cursor: pointer; padding: 4px 8px;
            border-radius: 6px; transition: all 0.2s;
        }
        .ctrl-btn:hover { background: #edf2f7; color: var(--primary-color); }

        /* Grid Â∏ÉÂ±Ä */
        .source-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }

        .source-checkbox { display: none; }

        /* Ê∫êÂç°ÁâáÊ†∑Âºè */
        .source-card {
            background: #fff;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px 8px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .source-name { 
            font-size: 14px; font-weight: 700; color: #4a5568; margin-bottom: 3px;
        }
        .source-desc { 
            font-size: 11px; color: #a0aec0; 
            line-height: 1.2; font-weight: 400;
        }

        /* ÈÄâ‰∏≠Áä∂ÊÄÅËÆæËÆ° */
        .source-checkbox:checked + .source-card {
            border-color: var(--primary-color);
            background: #eff3ff;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.15);
        }
        .source-checkbox:checked + .source-card .source-name { color: var(--primary-color); }
        .source-checkbox:checked + .source-card .source-desc { color: #7f9cf5; }

        /* ÈÄâ‰∏≠Êó∂ÁöÑÂè≥‰∏äËßíËßíÊ†á */
        .source-checkbox:checked + .source-card::after {
            content: '‚úì';
            position: absolute; top: 0; right: 0;
            background: var(--primary-color); color: white;
            font-size: 10px; width: 20px; height: 20px;
            border-bottom-left-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold;
        }

        /* --- ÁªìÊûúÂàóË°® --- */
        .result-list { list-style: none; padding: 0; display: flex; flex-direction: column; gap: 15px; }

        .song-card {
            background: #fff; padding: 15px; border-radius: 16px;
            box-shadow: var(--shadow); display: flex; align-items: center;
            transition: all 0.2s ease;
        }
        .song-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-active); }

        .cover-wrapper {
            width: 64px; height: 64px; border-radius: 10px; overflow: hidden;
            flex-shrink: 0; margin-right: 15px; background: #eee;
        }
        .cover-wrapper img { width: 100%; height: 100%; object-fit: cover; }

        .song-info { flex: 1; min-width: 0; margin-right: 10px; }
        .song-info h3 { margin: 0 0 6px; font-size: 16px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .artist-line { font-size: 13px; color: var(--text-sub); margin-bottom: 8px; }
        .tags { display: flex; gap: 6px; }
        .tag { font-size: 10px; padding: 3px 8px; border-radius: 6px; background: #edf2f7; color: #718096; font-weight: 600; }
        .tag-src { background: #ebf8ff; color: #3182ce; text-transform: uppercase; }

        .actions { display: flex; gap: 10px; }
        .btn-circle {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; text-decoration: none;
        }
        .btn-play { background: var(--primary-gradient); color: white; box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3); }
        .btn-play:hover { transform: scale(1.1); }
        .btn-dl { background: #f7fafc; color: var(--text-sub); border: 1px solid #e2e8f0; }
        .btn-dl:hover { border-color: var(--primary-color); color: var(--primary-color); }

        .no-results { text-align: center; padding: 60px; color: var(--text-sub); }

        /* APlayer & Ê≠åËØçÊ†∑Âºè */
        .aplayer.aplayer-fixed .aplayer-lrc {
            margin-bottom: 20px; padding-bottom: 20px; text-shadow: none !important;
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);
        }
        .aplayer .aplayer-lrc p {
            font-size: 16px !important; line-height: 32px !important;
            color: #000 !important; opacity: 0.1 !important; filter: blur(1px);
            transform: scale(0.95); transition: all 0.5s !important;
            margin: 0 !important; font-family: "PingFang SC", sans-serif !important;
        }
        .aplayer .aplayer-lrc p.aplayer-lrc-current ~ p { opacity: 0.5 !important; filter: blur(0px); }
        .aplayer .aplayer-lrc p.aplayer-lrc-current {
            font-size: 24px !important; opacity: 1 !important; filter: blur(0px);
            font-weight: 800 !important; margin: 15px 0 !important; transform: scale(1.05);
            background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* ÁßªÂä®Á´ØÈÄÇÈÖç */
        @media (max-width: 768px) {
            .container { padding: 0; }
            .search-box { padding: 20px; border-radius: 0 0 20px 20px; }
            .source-grid { grid-template-columns: repeat(3, 1fr); gap: 8px; }
            .source-card { padding: 8px 4px; }
            .source-name { font-size: 12px; }
            .source-desc { font-size: 9px; transform: scale(0.9); }
            .song-card { border-radius: 12px; margin: 0 15px 15px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="search-box">
        <h1>üéµ Music Hub</h1>
        <form action="/search" method="get">
            <div class="input-group">
                <input type="text" name="q" value="{{.Keyword}}" placeholder="ÊêúÁ¥¢Ê≠åÊõ≤„ÄÅÊ≠åÊâã„ÄÅ‰∏ìËæë..." required autocomplete="off">
                <button type="submit" class="search-btn"><i class="fa-solid fa-magnifying-glass"></i></button>
            </div>

            <div class="source-selector">
                <div class="source-header">
                    <span class="source-title">ÊêúÁ¥¢Ê∫êËÆæÁΩÆ</span>
                    <div>
                        <button type="button" class="ctrl-btn" id="btn-all">ÂÖ®ÈÄâ</button>
                        <button type="button" class="ctrl-btn" id="btn-none">Ê∏ÖÁ©∫</button>
                    </div>
                </div>
                
                <div class="source-grid">
                    {{ range $source := .AllSources }}
                    <label>
                        <input type="checkbox" name="sources" value="{{ $source }}" class="source-checkbox"
                            {{ if $.Selected }}
                                {{ range $.Selected }}{{ if eq . $source }}checked{{ end }}{{ end }}
                            {{ else }}
                                {{ range $.DefaultSources }}{{ if eq . $source }}checked{{ end }}{{ end }}
                            {{ end }}> 
                        
                        <div class="source-card">
                            <div class="source-name">{{ $source }}</div>
                            <div class="source-desc">{{ index $.SourceDescriptions $source }}</div>
                        </div>
                    </label>
                    {{ end }}
                </div>
            </div>
        </form>
    </div>

    {{ if .Result }}
        <ul class="result-list">
            {{ range .Result }}
            <li class="song-card">
                <div class="cover-wrapper">
                    {{ if .Cover }}
                        <img src="{{ .Cover }}" alt="{{ .Name }}" loading="lazy" referrerpolicy="no-referrer">
                    {{ else }}
                        <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:24px;">üéµ</div>
                    {{ end }}
                </div>
                <div class="song-info">
                    <h3>{{ .Name }}</h3>
                    <div class="artist-line">
                        <i class="fa-regular fa-user" style="font-size:11px;"></i> {{ .Artist }}
                        {{ if .Album }} &nbsp;‚Ä¢&nbsp; {{ .Album }}{{ end }}
                    </div>
                    <div class="tags">
                        <span class="tag tag-src">{{ .Source }}</span>
                        {{ if .FormatDuration }}<span class="tag">{{ .FormatDuration }}</span>{{ end }}
                        {{ if .FormatSize }}<span class="tag">{{ .FormatSize }}</span>{{ end }}
                    </div>
                </div>
                
                <div class="actions">
                    <button type="button" class="btn-circle btn-play" 
                            onclick="playMusic('{{.ID}}', '{{.Source}}', '{{.Name}}', '{{.Artist}}', '{{.Cover}}')">
                        <i class="fa-solid fa-play"></i>
                    </button>
                    <a href="/download?id={{ .ID }}&source={{ .Source }}&name={{ .Name }}&artist={{ .Artist }}" 
                       class="btn-circle btn-dl" target="_blank" download="{{ .Artist }} - {{ .Name }}.mp3">
                        <i class="fa-solid fa-download"></i>
                    </a>
                </div>
            </li>
            {{ end }}
        </ul>
    {{ else if .Keyword }}
        <div class="no-results">
            <i class="fa-solid fa-music" style="font-size: 40px; margin-bottom: 10px; display:block;"></i>
            <p>Êú™ÊâæÂà∞Á¨¶ÂêàÊù°‰ª∂ÁöÑËµÑÊ∫ê</p>
        </div>
    {{ end }}
</div>

<div id="aplayer"></div>

<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<script src="https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ÂÖ®ÈÄâ/Ê∏ÖÁ©∫ÈÄªËæë
        const checkboxes = document.querySelectorAll('.source-checkbox');
        document.getElementById('btn-all').onclick = () => checkboxes.forEach(cb => cb.checked = true);
        document.getElementById('btn-none').onclick = () => checkboxes.forEach(cb => cb.checked = false);
    });

    const ap = new APlayer({
        container: document.getElementById('aplayer'),
        fixed: true,
        autoplay: true,
        theme: '#667eea',
        loop: 'all',
        order: 'list',
        preload: 'auto',
        volume: 0.7,
        listFolded: false,
        lrcType: 3, 
        audio: []
    });

    function playMusic(id, source, name, artist, cover) {
        ap.list.clear();
        ap.list.add({
            name: name,
            artist: artist,
            url: `/download?id=${encodeURIComponent(id)}&source=${source}`,
            cover: cover || 'https://via.placeholder.com/150?text=Music',
            lrc: `/lyric?id=${encodeURIComponent(id)}&source=${source}`,
            theme: '#667eea'
        });
        ap.play();
    }
</script>

</body>
</html>