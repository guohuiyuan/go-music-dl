<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>music-dl - èšåˆæœç´¢ä¸è§£æ</title>
    <link rel="icon" href="{{.Root}}/icon.png" type="image/png">
    
    <link rel="stylesheet" href="{{.Root}}/style.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sakana-widget@2.7.1/lib/sakana.min.css"/>
</head>
<body>

<div id="back-to-top" class="back-to-top" onclick="scrollToTop()">
    <i class="fa-solid fa-arrow-up"></i>
</div>

<div class="settings-float" onclick="openCookieModal()" title="Cookie è®¾ç½®">
    <i class="fa-solid fa-gear"></i>
</div>

<div class="container">
    <div class="search-box">
        <h1>ğŸµ <a href="https://github.com/guohuiyuan/go-music-dl" target="_blank" style="color: inherit; text-decoration: none;">music-dl</a></h1>
        <form action="{{.Root}}/search" method="get" id="search-form">
            <div class="search-type-switch">
                <label class="type-option">
                    <input type="radio" name="type" value="song" 
                        {{ if or (eq .SearchType "song") (not .SearchType) }}checked{{ end }}
                        onchange="toggleSearchType(this.value)"> 
                    <span>å•æ›²æœç´¢</span>
                </label>
                <label class="type-option">
                    <input type="radio" name="type" value="playlist" 
                        {{ if eq .SearchType "playlist" }}checked{{ end }}
                        onchange="toggleSearchType(this.value)"> 
                    <span>æ­Œå•æœç´¢</span>
                </label>
            </div>

            <div class="input-group">
                <input type="text" name="q" value="{{.Keyword}}" placeholder="æœç´¢æ­Œæ›²ã€æ­Œæ‰‹... æˆ–ç›´æ¥ç²˜è´´åˆ†äº«é“¾æ¥" required autocomplete="off">
                <button type="submit" class="search-btn"><i class="fa-solid fa-magnifying-glass"></i></button>
            </div>

            <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap;">
                <button type="button" class="btn-pill btn-pill-primary" onclick="goToRecommend()" 
                    style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); border: none; box-shadow: 0 4px 15px rgba(255, 154, 158, 0.4); justify-content:center;">
                    <i class="fa-solid fa-fire"></i> è·å–æ¯æ—¥æ¨èæ­Œå•
                </button>
                <button type="button" class="btn-pill btn-pill-fav" onclick="openCollectionManager()">
                    <i class="fa-solid fa-folder-open"></i> æˆ‘çš„è‡ªåˆ¶æ­Œå•
                </button>
            </div>

            {{ if .Error }}
            <div class="error-msg">
                <i class="fa-solid fa-circle-exclamation"></i> {{ .Error }}
            </div>
            {{ end }}

            <div class="source-selector">
                <div class="source-header">
                    <span class="source-title">æœç´¢æºè®¾ç½®</span>
                    <div>
                        <button type="button" class="ctrl-btn" id="btn-all">å…¨é€‰</button>
                        <button type="button" class="ctrl-btn" id="btn-none">æ¸…ç©º</button>
                    </div>
                </div>
                
                <div class="source-grid">
                    {{ range $source := .AllSources }}
                    <label>
                        <input type="checkbox" name="sources" value="{{ $source }}" class="source-checkbox"
                            data-supported="{{ index $.PlaylistSupported $source }}"
                            {{ if $.Selected }}
                                {{ range $.Selected }}{{ if eq . $source }}checked{{ end }}{{ end }}
                            {{ else }}
                                {{ range $.DefaultSources }}{{ if eq . $source }}checked{{ end }}{{ end }}
                            {{ end }}> 
                        <div class="source-card">
                            <div class="source-name">{{ $source }}</div>
                            <div class="source-desc">{{ index $.SourceDescriptions $source }}</div>
                        </div>
                    </label>
                    {{ end }}
                </div>
            </div>
        </form>
    </div>

    {{ if .IsLocalColPage }}
        <div class="list-header" style="margin-bottom: 20px;">
            <div>
                <span class="result-count" style="font-size: 16px;"><i class="fa-solid fa-folder-open"></i> æœ¬åœ°è‡ªåˆ¶æ­Œå• (å…± {{ len .Playlists }} ä¸ª)</span>
            </div>
            <button type="button" class="btn-pill btn-pill-primary" onclick="showEditCollectionModal()">
                <i class="fa-solid fa-plus"></i> æ–°å»ºæ­Œå•
            </button>
        </div>
    {{ end }}

    {{ if .Playlists }}
        <div class="playlist-grid-container">
            {{ range .Playlists }}
            <div class="playlist-card" onclick="location.href='{{$.Root}}/{{ if eq .Source "local" }}collection?id={{.ID}}{{ else }}playlist?id={{.ID}}&source={{.Source}}{{ end }}'">
                <div class="playlist-cover">
                    <img src="{{ .Cover }}" loading="lazy" onerror="this.src='https://via.placeholder.com/400?text=Cover'">
                    <span class="tag {{ if eq .Source "local" }}tag-local{{ else }}tag-src{{ end }}" style="position:absolute; top:5px; right:5px; margin:0; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                        {{ if eq .Source "local" }}æœ¬åœ°æ­Œå•{{ else }}{{ .Source }}{{ end }}
                    </span>
                </div>
                <div class="playlist-meta">
                    <div class="playlist-title">
                        {{ .Name }}
                        {{ if .Link }}
                        <a href="{{ .Link }}" target="_blank" class="external-link-icon" title="å»åŸç½‘é¡µ" onclick="event.stopPropagation()">
                            <i class="fa-solid fa-arrow-up-right-from-square" style="font-size: 12px;"></i>
                        </a>
                        {{ end }}
                    </div>
                    <div class="playlist-author"><i class="fa-regular fa-user"></i> {{ .Creator }}</div>
                    
                    <div style="display:flex; justify-content: space-between; align-items: flex-end; margin-top: auto;">
                        <div class="playlist-count">å…± {{ .TrackCount }} é¦–</div>
                        
                        {{ if eq .Source "local" }}
                        <div style="display:flex; gap:6px;">
                            <button class="col-action-btn" onclick="event.stopPropagation(); showEditCollectionModal('{{.ID}}', '{{.Name}}', '{{.Description}}', '{{.Cover}}')" title="ç¼–è¾‘æ­Œå•"><i class="fa-solid fa-pen"></i></button>
                            <button class="col-action-btn del" onclick="event.stopPropagation(); deleteCollection('{{.ID}}')" title="åˆ é™¤æ­Œå•"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        {{ end }}
                    </div>
                </div>
            </div>
            {{ end }}
        </div>
    {{ else if .Result }}
        <div class="list-header">
            <div>
                {{ if .ColID }}
                <span class="result-count" style="font-size: 16px;"><i class="fa-solid fa-folder-open"></i> æ­£åœ¨æŸ¥çœ‹: <span style="color:#10b981; margin-left: 5px;">{{ .ColName }}</span> (å…± {{ len .Result }} é¦–)</span>
                {{ else }}
                <span class="result-count"><i class="fa-solid fa-music"></i> æ‰¾åˆ° <span class="count">{{ len .Result }}</span> é¦–æ­Œæ›²</span>
                {{ if .PlaylistLink }}
                    <a href="{{ .PlaylistLink }}" target="_blank" class="playlist-source-link">
                        <i class="fa-solid fa-arrow-up-right-from-square"></i> æ‰“å¼€åŸå§‹æ­Œå•
                    </a>
                {{ end }}
                {{ end }}
            </div>

            <div style="display:flex; gap:10px;">
                <button type="button" class="ctrl-btn primary" onclick="playAllSongs()">
                    <i class="fa-solid fa-play"></i> æ’­æ”¾å…¨éƒ¨
                </button>
                <button type="button" class="ctrl-btn primary" id="btn-batch-toggle" onclick="toggleBatchMode()">
                    <i class="fa-solid fa-list-check"></i> æ‰¹é‡æ“ä½œ
                </button>
            </div>
        </div>

        <div class="batch-toolbar" id="batch-toolbar">
            <div class="batch-info">
                <div>
                    <label><input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this)"> å…¨é€‰</label>
                    <span style="margin-left: 5px; color: #718096; font-size:12px;">å·²é€‰ <span id="selected-count" style="color: #10b981; font-weight: bold;">0</span></span>
                </div>
                <button class="btn-pill btn-pill-warn" onclick="selectInvalidSongs()">
                    <i class="fa-solid fa-triangle-exclamation"></i> é€‰æ‹©æ— æ•ˆ
                </button>
            </div>
            <div class="batch-actions">
                <button class="btn-pill btn-pill-switch" id="btn-batch-switch" onclick="batchSwitchSource()" disabled>
                    <i class="fa-solid fa-arrows-rotate"></i> æ‰¹é‡æ¢æº
                </button>
                <button class="btn-pill btn-pill-dl" id="btn-batch-dl" onclick="batchDownload()" disabled>
                    <i class="fa-solid fa-download"></i> æ‰¹é‡ä¸‹è½½
                </button>
            </div>
        </div>

        <ul class="result-list">
            {{ range .Result }}
            <li class="song-card" 
                data-id="{{.ID}}" 
                data-source="{{.Source}}" 
                data-duration="{{.Duration}}" 
                data-name="{{.Name}}" 
                data-artist="{{.Artist}}"
                data-cover="{{.Cover}}">
                
                <div class="checkbox-wrapper">
                    <input type="checkbox" class="song-checkbox" onclick="event.stopPropagation(); updateBatchToolbar();">
                </div>

                <div class="cover-wrapper">
                    {{ if .Cover }}
                        <img src="{{ .Cover }}" alt="{{ .Name }}" loading="lazy" onerror="this.src='https://via.placeholder.com/150?text=Music'" >
                    {{ else }}
                        <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:24px;">ğŸµ</div>
                        <img src="https://via.placeholder.com/150?text=Music" style="display:none;">
                    {{ end }}
                </div>
                <div class="song-info">
                    <h3>
                        {{ if .Link }}
                            <a href="{{ .Link }}" target="_blank" class="song-title-link" title="æ‰“å¼€åŸå§‹é“¾æ¥">{{ .Name }}</a>
                        {{ else }}
                            {{ .Name }}
                        {{ end }}
                    </h3>
                    <div class="artist-line">
                        <i class="fa-regular fa-user" style="font-size:11px;"></i> {{ .Artist }}
                        {{ if .Album }} &nbsp;â€¢&nbsp; {{ .Album }}{{ end }}
                    </div>
                    <div class="tags">
                        <span class="tag tag-src">{{ .Source }}</span>
                        <span class="tag tag-duration">{{ if .FormatDuration }}{{ .FormatDuration }}{{ else }}-{{ end }}</span>
                        <span class="tag tag-loading" id="size-{{.ID}}"><i class="fa fa-spinner fa-spin"></i></span>
                        <span class="tag tag-loading" id="bitrate-{{.ID}}"><i class="fa fa-circle-notch fa-spin"></i></span>
                    </div>
                </div>
                
                <div class="actions">
                    <button type="button" class="btn-circle btn-play" title="æ’­æ”¾"
                            onclick="playAllAndJumpTo(this)">
                        <i class="fa-solid fa-play"></i>
                    </button>

                    <button type="button" class="btn-circle btn-switch" title="æ¢æº"
                            onclick="switchSource(this)">
                        <i class="fa-solid fa-arrows-rotate"></i>
                    </button>
                    
                    {{ if $.ColID }}
                    <button type="button" class="btn-circle btn-fav" title="ç§»å‡ºå½“å‰æ­Œå•"
                            onclick="removeSongFromCollection(this, '{{$.ColID}}', '{{.ID}}', '{{.Source}}')">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                    {{ else }}
                    <button type="button" class="btn-circle btn-fav" title="æ”¶è—åˆ°è‡ªåˆ¶æ­Œå•"
                            onclick="openAddToCollectionModal(this)">
                        <i class="fa-regular fa-heart"></i>
                    </button>
                    {{ end }}

                    <a href="{{$.Root}}/download?id={{.ID}}&source={{.Source}}&name={{.Name}}&artist={{.Artist}}" 
                       id="dl-{{.ID}}" class="btn-circle btn-dl btn-download" title="ä¸‹è½½æ­Œæ›²" target="_blank">
                        <i class="fa-solid fa-download"></i>
                    </a>

                    <a href="{{$.Root}}/download_lrc?id={{.ID}}&source={{.Source}}&name={{.Name}}&artist={{.Artist}}" 
                       id="lrc-{{.ID}}" class="btn-circle btn-dl btn-lyric" title="ä¸‹è½½æ­Œè¯" target="_blank">
                        <i class="fa-solid fa-file-lines"></i>
                    </a>

                    <a href="{{$.Root}}/download_cover?url={{ .Cover }}&name={{ .Name }}&artist={{ .Artist }}" 
                       class="btn-circle btn-dl btn-cover" title="ä¸‹è½½å°é¢" target="_blank">
                        <i class="fa-regular fa-image"></i>
                    </a>
                </div>
            </li>
            {{ end }}
        </ul>
    {{ else if .Keyword }}
        {{ if not .Error }}
        <div class="no-results">
            <i class="fa-solid fa-music" style="font-size: 40px; margin-bottom: 10px; display:block;"></i>
            <p>æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„èµ„æº</p>
        </div>
        {{ end }}
    {{ end }}
</div>

<div id="cookieModal" class="modal-overlay" style="z-index: 1001;">
    <div class="modal">
        <div class="modal-header">
            <h3>è®¾ç½® Cookies</h3>
            <div class="modal-close" onclick="document.getElementById('cookieModal').style.display='none'"><i class="fa-solid fa-xmark"></i></div>
        </div>
        <div class="modal-body">
            <div class="cookie-list">
                {{ range $source := .AllSources }}
                <div class="cookie-item">
                    <label>{{ $source }}</label>
                    <input type="text" id="cookie-{{$source}}" placeholder="åœ¨æ­¤ç²˜è´´ Cookie...">
                </div>
                {{ end }}
            </div>
            <button class="btn-save" onclick="saveCookies()">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>
</div>

<div id="editCollectionModal" class="modal-overlay" style="z-index: 1005;">
    <div class="modal" style="max-width: 400px;">
        <div class="modal-header">
            <h3 id="editColTitle">æ–°å»ºæ­Œå•</h3>
            <div class="modal-close" onclick="document.getElementById('editCollectionModal').style.display='none'"><i class="fa-solid fa-xmark"></i></div>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editColId">
            <div class="cookie-item">
                <label>æ­Œå•åç§° <span style="color:#e53e3e;">*</span></label>
                <input type="text" id="editColName" placeholder="ä¾‹å¦‚: ç¡å‰å¬çš„æ­Œ" maxlength="30">
            </div>
            <div class="cookie-item">
                <label>æè¿°</label>
                <input type="text" id="editColDesc" placeholder="ç®€å•æè¿°ä¸€ä¸‹...">
            </div>
            <div class="cookie-item">
                <label>å°é¢å›¾ç‰‡ (URL)</label>
                <input type="text" id="editColCover" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨ä¸ºæ‚¨ç”Ÿæˆéšæœºç²¾ç¾å°é¢">
            </div>
            <button type="button" class="btn-save" onclick="saveCollection()">ä¿å­˜æ­Œå•</button>
        </div>
    </div>
</div>

<div id="addToCollectionModal" class="modal-overlay" style="z-index: 1004;">
    <div class="modal" style="max-width: 400px;">
        <div class="modal-header">
            <h3>æ”¶è—åˆ°æˆ‘çš„æ­Œå•</h3>
            <div class="modal-close" onclick="document.getElementById('addToCollectionModal').style.display='none'"><i class="fa-solid fa-xmark"></i></div>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 14px; color: var(--text-sub);">é€‰æ‹©æˆ–ç®¡ç†æ­Œå•</span>
                <button class="btn-pill btn-pill-primary" style="padding: 6px 12px; font-size: 12px;" onclick="showEditCollectionModal()">
                    <i class="fa-solid fa-plus"></i> æ–°å»º
                </button>
            </div>
            <div id="addColList">
                </div>
        </div>
    </div>
</div>

<div id="aplayer"></div>

<div id="sakana-container" class="sakana-container">
    <div id="sakana-widget"></div>
    <button class="sakana-btn" onclick="changeSakanaSkin()"><i class="fa-solid fa-rotate"></i> æ¢å›¾</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>

<script>
    window.API_ROOT = "{{.Root}}";
    window.sakanaInstance = null;
    
    // åˆå§‹åŒ– Sakana æ’ä»¶ (æ¥å…¥éšæœºäºŒæ¬¡å…ƒ API)
    function initSakanaWidget() {
        if (window.innerWidth > 768) {
            // è·å–é»˜è®¤è§’è‰²æ¨¡æ¿
            const customChar = SakanaWidget.getCharacter('chisato');
            // åŠ ä¸Šæ—¶é—´æˆ³é¿å…æµè§ˆå™¨ç¼“å­˜å¯¼è‡´å›¾ç‰‡ä¸æ›´æ–°
            customChar.image = 'https://www.loliapi.com/acg/pe/?t=' + Date.now();
            SakanaWidget.registerCharacter('my-random-acg', customChar);
            window.sakanaInstance = new SakanaWidget({ character: 'my-random-acg' }).mount('#sakana-widget');
        }
    }

    // ç‚¹å‡»æŒ‰é’®ï¼Œæ— æ„Ÿåˆ‡æ¢è§’è‰²çš®è‚¤å›¾ç‰‡
    function changeSakanaSkin() {
        if (!window.sakanaInstance) return;
        const customChar = SakanaWidget.getCharacter('my-random-acg');
        customChar.image = 'https://www.loliapi.com/acg/pe/?t=' + Date.now();
        SakanaWidget.registerCharacter('my-random-acg', customChar);
        window.sakanaInstance.setCharacter('my-random-acg');
    }
</script>

<script src="{{.Root}}/app.js"></script>
{{ template "videogen.html" . }}
<script src="{{.Root}}/videogen.js"></script>

<script async onload="initSakanaWidget()" src="https://cdn.jsdelivr.net/npm/sakana-widget@2.7.1/lib/sakana.min.js"></script>

</body>
</html>