name: 推送代码检查
on:
  push:
    branches:
      - master
jobs:
  golangci:
    name: lint
    runs-on: ubuntu-latest
    steps:
      - name: Set up Go
        uses: actions/setup-go@master
        with:
          go-version: '1.25'

      - name: Check out code into the Go module directory
        uses: actions/checkout@master
        with:
          ref: master
          fetch-depth: 0
          submodules: 'recursive'

      - name: Tidy Modules
        run: |
          # 调试信息
          pwd
          ls -la
          # 检查 cmd/music-dl 目录是否存在
          if [ ! -d "./cmd/music-dl" ]; then
            echo "::error:: 缺少 cmd/music-dl 目录，请检查代码提交"
            echo "当前目录内容:"
            find . -type f -name "*.go" | head -20
            exit 1
          fi
          # 初始化 Go 模块
          go mod tidy
          go mod download
          go generate ./...

      - name: Run Lint
        uses: golangci/golangci-lint-action@master
        with:
          version: latest

      - name: Commit back
        if: ${{ !github.head_ref }}
        continue-on-error: true
        run: |
          git config --local user.name 'github-actions[bot]'
          git config --local user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git add --all
          git commit -m "chore(lint): 改进代码样式"

      - name: Create Pull Request
        if: ${{ !github.head_ref }}
        continue-on-error: true
        uses: peter-evans/create-pull-request@v8
        with:
          title: "chore(lint): 改进代码样式"
