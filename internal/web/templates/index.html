<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>Music Hub - ËÅöÂêàÊêúÁ¥¢‰∏éËß£Êûê</title>
    <link rel="icon" href="/icon.png" type="image/png">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css">

    <style>
        :root {
            --primary-color: #667eea;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-color: #f5f7fa;
            --card-bg: #ffffff;
            --text-main: #2d3748;
            --text-sub: #718096;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --shadow-active: 0 10px 15px -3px rgba(102, 126, 234, 0.2);
            --error-color: #e53e3e;
            
            /* ÊåâÈíÆÈ¢úËâ≤ÂÆö‰πâ */
            --btn-switch-bg: #fff7ed;
            --btn-switch-text: #9a3412;
            --btn-switch-border: #fed7aa;
            --btn-switch-hover: #c2410c;
            
            --btn-dl-bg: #ebf8ff;
            --btn-dl-text: #2b6cb0;
            --btn-dl-border: #bee3f8;
            --btn-dl-hover: #2c5282;

            --btn-warn-bg: #fff5f5;
            --btn-warn-text: #c53030;
            --btn-warn-border: #feb2b2;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #eef2f5;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-size: 100% 600px;
            background-repeat: no-repeat;
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px 150px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            -webkit-tap-highlight-color: transparent;
        }

        .container { width: 100%; max-width: 900px; z-index: 1; }

        /* Search Box */
        .search-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.5);
            position: relative; 
            z-index: 10;
        }

        h1 {
            text-align: center; margin: 0 0 25px 0;
            font-size: 2.2rem; font-weight: 800; letter-spacing: -1px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* ÊêúÁ¥¢Á±ªÂûãÂàáÊç¢ */
        .search-type-switch {
            display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;
        }
        .type-option {
            display: flex; align-items: center; gap: 8px; cursor: pointer;
            font-weight: 600; color: var(--text-sub); transition: color 0.2s;
        }
        .type-option input { margin: 0; cursor: pointer; accent-color: var(--primary-color); }
        .type-option:hover { color: var(--primary-color); }
        .type-option input:checked + span { color: var(--primary-color); }

        .input-group { display: flex; gap: 10px; margin-bottom: 25px; }
        
        input[type="text"] {
            flex: 1; padding: 14px 24px;
            border: 2px solid #e2e8f0; border-radius: 50px;
            font-size: 16px; outline: none; transition: all 0.3s;
            background: #f8fafc;
            min-width: 0;
        }
        input[type="text"]:focus {
            border-color: var(--primary-color); background: #fff;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
        }

        .search-btn {
            padding: 0 32px; border: none; border-radius: 50px;
            background: var(--primary-gradient); color: white;
            font-size: 16px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            flex-shrink: 0;
        }
        .search-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4); }

        /* Error Message */
        .error-msg {
            background: #fff5f5; color: var(--error-color);
            padding: 12px; border-radius: 8px; margin-bottom: 20px;
            border: 1px solid #fed7d7; text-align: center; font-size: 14px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        /* Source Selector */
        .source-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #edf2f7;
        }
        .source-title { font-weight: 700; color: var(--text-sub); font-size: 0.9rem; }
        .ctrl-btn {
            background: none; border: none; color: var(--text-sub);
            font-size: 12px; cursor: pointer; padding: 4px 8px;
            border-radius: 6px; transition: all 0.2s;
        }
        .ctrl-btn:hover { background: #edf2f7; color: var(--primary-color); }
        .ctrl-btn.primary {
            background: #f7f9ff; color: var(--primary-color);
            border: 1px solid #dbe3ff; padding: 6px 12px;
            font-weight: 600; border-radius: 999px;
        }
        .ctrl-btn.primary:hover { background: #eff3ff; }

        .source-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }
        .source-checkbox { display: none; }
        .source-card {
            background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 10px 8px;
            cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .source-name { font-size: 14px; font-weight: 700; color: #4a5568; margin-bottom: 3px; }
        .source-desc { font-size: 11px; color: #a0aec0; line-height: 1.2; font-weight: 400; }
        
        /* ÈÄâ‰∏≠Áä∂ÊÄÅ */
        .source-checkbox:checked + .source-card {
            border-color: var(--primary-color); background: #eff3ff;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.15);
        }
        .source-checkbox:checked + .source-card .source-name { color: var(--primary-color); }
        .source-checkbox:checked + .source-card .source-desc { color: #7f9cf5; }

        /* Á¶ÅÁî®Áä∂ÊÄÅ */
        .source-checkbox:disabled + .source-card {
            opacity: 0.5; cursor: not-allowed; background: #f7fafc; border-color: #e2e8f0;
        }

        /* Results */
        .list-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding: 10px 12px;
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid #edf2f7; border-radius: 12px;
            box-shadow: var(--shadow);
        }
        .list-header .result-count {
            color: var(--text-main); font-size: 14px; font-weight: 700;
            display: flex; align-items: center; gap: 8px;
        }
        .list-header .result-count .count { color: var(--primary-color); }
        
        /* ÊâπÈáèÊìç‰ΩúÊ†∑Âºè */
        .checkbox-wrapper {
            display: none; width: 30px; align-items: center; justify-content: center; margin-right: 10px;
        }
        body.batch-mode .checkbox-wrapper { display: flex; }
        body.batch-mode .song-card { padding-left: 10px; }
        
        /* ÊâπÈáèÊìç‰ΩúÊ†è */
        .batch-toolbar {
            display: none;
            background: #fff;
            padding: 15px 20px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 2px solid var(--primary-color);
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .batch-toolbar.active { display: flex; }
        
        .batch-info { font-size: 14px; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 12px; }
        .batch-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        
        .btn-pill {
            padding: 8px 18px; border-radius: 20px; font-size: 14px; font-weight: 600;
            cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;
            border: 1px solid transparent;
        }
        .btn-pill:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(0.8); }

        .btn-pill-primary { background: var(--primary-color); color: white; }
        .btn-pill-primary:hover { background: #5a67d8; transform: translateY(-1px); }
        
        .btn-pill-switch { background: var(--btn-switch-bg); color: var(--btn-switch-text); border-color: var(--btn-switch-border); }
        .btn-pill-switch:hover:not(:disabled) { border-color: #f97316; background: #fffaf0; }

        .btn-pill-dl { background: var(--btn-dl-bg); color: var(--btn-dl-text); border-color: var(--btn-dl-border); }
        .btn-pill-dl:hover:not(:disabled) { border-color: #3182ce; background: #ebf8ff; }

        .btn-pill-warn { background: var(--btn-warn-bg); color: var(--btn-warn-text); border-color: var(--btn-warn-border); padding: 4px 12px; font-size: 13px; }
        .btn-pill-warn:hover { background: #fee2e2; border-color: #f87171; }

        .result-list { list-style: none; padding: 0; display: flex; flex-direction: column; gap: 15px; }
        
        .song-card {
            background: #fff; padding: 15px; border-radius: 16px;
            box-shadow: var(--shadow); display: flex; align-items: center;
            transition: all 0.2s ease; position: relative; z-index: 5;
            border: 2px solid transparent;
        }
        .song-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-active); }
        .song-card.playing-active {
            border-color: var(--primary-color); background: #eff3ff;
            transform: scale(1.01); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.25);
        }
        .song-card.selected { border-color: var(--primary-color); background: #f7fafc; }

        .cover-wrapper {
            width: 64px; height: 64px; border-radius: 10px; overflow: hidden;
            flex-shrink: 0; margin-right: 15px; background: #eee;
        }
        .cover-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        .song-info { flex: 1; min-width: 0; margin-right: 10px; }
        .song-info h3 { margin: 0 0 6px; font-size: 16px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .artist-line { font-size: 13px; color: var(--text-sub); margin-bottom: 8px; }
        .tags { display: flex; gap: 6px; }
        .tag { font-size: 10px; padding: 3px 8px; border-radius: 6px; background: #edf2f7; color: #718096; font-weight: 600; }
        .tag-src { background: #ebf8ff; color: #3182ce; text-transform: uppercase; }
        
        .tag-loading { color: #d69e2e; } 
        .tag-success { color: #38a169; }
        .tag-fail { color: #e53e3e; }

        .actions { display: flex; gap: 8px; }
        .btn-circle {
            width: 36px; height: 36px; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; text-decoration: none;
            position: relative; z-index: 10; font-size: 14px;
        }
        .btn-play { background: var(--primary-gradient); color: white; box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3); }
        .btn-play:hover { transform: scale(1.1); }
        .btn-dl { background: #f7fafc; color: var(--text-sub); border: 1px solid #e2e8f0; }
        .btn-dl:hover { border-color: var(--primary-color); color: var(--primary-color); }
        .btn-switch { background: var(--btn-switch-bg); color: var(--btn-switch-text); border: 1px solid var(--btn-switch-border); }
        .btn-switch:hover { border-color: #fb923c; color: #c2410c; }

        /* Playlist Grid */
        .playlist-grid-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px;
        }
        .playlist-card {
            background: #fff; border-radius: 16px; overflow: hidden;
            box-shadow: var(--shadow); cursor: pointer; transition: all 0.2s;
            display: flex; flex-direction: column; text-decoration: none; color: inherit;
        }
        .playlist-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-active); }
        .playlist-cover {
            width: 100%; aspect-ratio: 1; background: #eee; position: relative;
        }
        .playlist-cover img { width: 100%; height: 100%; object-fit: cover; }
        .playlist-meta { padding: 12px; flex: 1; display: flex; flex-direction: column; }
        .playlist-title {
            font-size: 14px; font-weight: 700; margin: 0 0 6px 0;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        .playlist-author { font-size: 12px; color: var(--text-sub); margin-bottom: 4px; }
        .playlist-count { font-size: 11px; color: #a0aec0; margin-top: auto; }

        .no-results { text-align: center; padding: 60px; color: var(--text-sub); }

        /* Cookie Modal & APlayer */
        .settings-float {
            position: absolute; top: 30px; right: 30px;
            background: white; border-radius: 50%; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            color: var(--text-sub); transition: 0.2s; z-index: 20;
        }
        .settings-float:hover { color: var(--primary-color); transform: rotate(90deg); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; display: none;
            align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal {
            background: white; padding: 25px; border-radius: 20px;
            width: 90%; max-width: 450px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        .cookie-list { max-height: 400px; overflow-y: auto; margin: 15px 0; }
        .cookie-item { margin-bottom: 10px; }
        .cookie-item label { display: block; font-size: 12px; color: #718096; margin-bottom: 4px; font-weight: 600; }
        .cookie-item input {
            width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 8px;
            font-size: 12px; box-sizing: border-box;
        }
        .btn-save {
            width: 100%; padding: 10px; background: var(--primary-gradient);
            color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;
        }

        /* [Êñ∞Â¢û] ÂõûÂà∞È°∂ÈÉ®ÊåâÈíÆÊ†∑Âºè (Ê°åÈù¢Á´Ø) */
        .back-to-top {
            position: fixed;
            bottom: 120px; /* ÈªòËÆ§‰ΩçÁΩÆ */
            right: 140px;  /* [Ë∞ÉÊï¥] ÂêëÂ∑¶ÁßªÂä®ÔºåÈÅøÂºÄ Live2D */
            width: 45px;
            height: 45px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 200000; /* [Ë∞ÉÊï¥] Â±ÇÁ∫ßÈ´ò‰∫é Live2D (99999) */
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            color: var(--primary-color);
            font-size: 20px;
        }
        .back-to-top.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .back-to-top:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-5px);
        }

        /* APlayer & Waifu */
        /* Âº∫Âà∂ÊèêÂçá APlayer Â±ÇÁ∫ßÔºåÁ°Æ‰øùÁßªÂä®Á´ØÂèØÊéßÂà∂ */
        .aplayer.aplayer-fixed {
            z-index: 10000 !important;
        }

        /* Ê°åÈù¢Á´ØÊ≠åËØç‰ΩçÁΩÆ */
        .aplayer.aplayer-fixed .aplayer-lrc {
            margin-bottom: 40px; padding-bottom: 20px; text-shadow: none !important;
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 100%);
            mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 100%);
            pointer-events: none !important;
        }
        .aplayer .aplayer-lrc p {
            font-size: 16px !important; line-height: 32px !important;
            color: #000 !important; opacity: 0.1 !important; filter: blur(1px);
            transform: scale(0.95); transition: all 0.5s !important;
            margin: 0 !important; font-family: "PingFang SC", sans-serif !important;
        }
        .aplayer .aplayer-lrc p.aplayer-lrc-current ~ p { opacity: 0.5 !important; filter: blur(0px); }
        .aplayer .aplayer-lrc p.aplayer-lrc-current {
            font-size: 24px !important; opacity: 1 !important; filter: blur(0px);
            font-weight: 800 !important; margin: 15px 0 !important; transform: scale(1.05);
            background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        #waifu {
            left: auto !important; right: 20px !important; bottom: 90px !important;
            z-index: 99999 !important; pointer-events: none !important;
        }
        #waifu canvas, #waifu-tool, #waifu-tips { pointer-events: auto !important; }

        /* ================= ÁßªÂä®Á´ØÈÄÇÈÖç ================= */
        @media (max-width: 768px) {
            #waifu { display: none; }
            body { padding: 0 0 200px 0; background-size: 100% 400px; }
            .container { padding: 0; width: 100%; }
            .search-box { 
                padding: 20px 15px; border-radius: 0 0 20px 20px; margin-bottom: 20px;
                border-left: none; border-right: none; border-top: none;
            }
            h1 { font-size: 1.8rem; margin-bottom: 20px; }
            .input-group { margin-bottom: 15px; flex-direction: column; }
            .search-btn { width: 100%; height: 44px; }
            .source-grid { grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 8px; }
            .source-card { padding: 8px 4px; min-height: 40px; justify-content: center; }
            .source-name { font-size: 12px; }
            .source-desc { display: none; }
            .result-list { padding: 0 12px; gap: 12px; }
            .playlist-grid-container { padding: 0 12px; grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .playlist-meta { padding: 8px; }
            .playlist-title { font-size: 12px; margin-bottom: 4px; }
            .song-card { margin: 0; padding: 12px; border-radius: 12px; align-items: flex-start; }
            .cover-wrapper { width: 54px; height: 54px; margin-right: 12px; border-radius: 8px; }
            .song-info h3 { font-size: 15px; margin-bottom: 4px; max-width: 100%; white-space: normal; }
            .artist-line { font-size: 12px; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
            .tags { flex-wrap: wrap; }
            .tag { padding: 2px 5px; }
            .actions { display: grid; grid-template-columns: repeat(2, 34px); grid-auto-rows: 34px; gap: 8px; flex-shrink: 0; justify-content: flex-end; }
            .btn-circle { width: 34px; height: 34px; font-size: 13px; }
            .btn-cover { display: none !important; }
            .settings-float { top: 15px; right: 15px; width: 36px; height: 36px; }
            .modal { width: 85%; max-height: 80vh; padding: 20px; }
            
            /* ÁßªÂä®Á´ØÊ≠åËØç‰ΩçÁΩÆ‰∏äÁßªÔºåÈò≤Ê≠¢ÈÅÆÊå°ÔºõÊ†∑Âºè‰∏é Web ‰øùÊåÅ‰∏ÄËá¥ */
            .aplayer.aplayer-fixed .aplayer-lrc {
                bottom: 180px !important; 
                margin-bottom: 0 !important;
                max-height: 150px !important; 
                text-shadow: none !important; /* ÁßªÈô§ÁßªÂä®Á´ØÁâπÊúâÁöÑÈò¥ÂΩ±Ôºå‰øùÊåÅ‰∏ÄËá¥ */
            }
            .aplayer .aplayer-lrc p { font-size: 18px !important; }
            
            /* ÁßªÂä®Á´ØÊâπÈáèÊìç‰ΩúÊ†èÂ∏ÉÂ±Ä */
            .batch-toolbar { 
                padding: 12px; 
                border-radius: 12px;
                flex-direction: column; 
                align-items: stretch;
            }
            .batch-info { justify-content: center; flex-wrap: wrap;}
            .batch-actions { flex-direction: column; justify-content: flex-start; }
            .btn-pill { width: 100%; justify-content: center; }

            /* ÁßªÂä®Á´ØÊí≠ÊîæÂô®Â±ïÂºÄËá™ÈÄÇÂ∫î */
            .aplayer.aplayer-fixed {
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                border-radius: 0 !important;
                bottom: 0 !important;
                transform: translateY(-18px);
            }
            .aplayer.aplayer-fixed .aplayer-list {
                max-height: 40vh !important;
            }

            /* [Êñ∞Â¢û] ÁßªÂä®Á´ØÂõûÂà∞È°∂ÈÉ®ÊåâÈíÆ‰ΩçÁΩÆÂæÆË∞É */
            .back-to-top {
                bottom: 220px; /* ÈÅøÂºÄÊ≠åËØçÂíåÂ∫ïÈÉ®Êìç‰ΩúÊ†è */
                right: 20px;
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>

<div id="back-to-top" class="back-to-top" onclick="scrollToTop()">
    <i class="fa-solid fa-arrow-up"></i>
</div>

<div class="settings-float" onclick="openCookieModal()" title="Cookie ËÆæÁΩÆ">
    <i class="fa-solid fa-gear"></i>
</div>

<div class="container">
    <div class="search-box">
        <h1>üéµ Music Hub</h1>
        <form action="/search" method="get" id="search-form">
            <div class="search-type-switch">
                <label class="type-option">
                    <input type="radio" name="type" value="song" 
                        {{ if or (eq .SearchType "song") (not .SearchType) }}checked{{ end }}
                        onchange="toggleSearchType(this.value)"> 
                    <span>ÂçïÊõ≤ÊêúÁ¥¢</span>
                </label>
                <label class="type-option">
                    <input type="radio" name="type" value="playlist" 
                        {{ if eq .SearchType "playlist" }}checked{{ end }}
                        onchange="toggleSearchType(this.value)"> 
                    <span>Ê≠åÂçïÊêúÁ¥¢</span>
                </label>
            </div>

            <div class="input-group">
                <input type="text" name="q" value="{{.Keyword}}" placeholder="ÊêúÁ¥¢Ê≠åÊõ≤„ÄÅÊ≠åÊâã... ÊàñÁõ¥Êé•Á≤òË¥¥ÂàÜ‰∫´ÈìæÊé•" required autocomplete="off">
                <button type="submit" class="search-btn"><i class="fa-solid fa-magnifying-glass"></i></button>
            </div>

            <div style="text-align: center; margin-bottom: 20px;">
                <button type="button" class="btn-pill btn-pill-primary" onclick="goToRecommend()" 
                    style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); border: none; box-shadow: 0 4px 15px rgba(255, 154, 158, 0.4); justify-content:center;">
                    <i class="fa-solid fa-fire"></i> Ëé∑ÂèñÊØèÊó•Êé®ËçêÊ≠åÂçï
                </button>
            </div>

            {{ if .Error }}
            <div class="error-msg">
                <i class="fa-solid fa-circle-exclamation"></i> {{ .Error }}
            </div>
            {{ end }}

            <div class="source-selector">
                <div class="source-header">
                    <span class="source-title">ÊêúÁ¥¢Ê∫êËÆæÁΩÆ</span>
                    <div>
                        <button type="button" class="ctrl-btn" id="btn-all">ÂÖ®ÈÄâ</button>
                        <button type="button" class="ctrl-btn" id="btn-none">Ê∏ÖÁ©∫</button>
                    </div>
                </div>
                
                <div class="source-grid">
                    {{ range $source := .AllSources }}
                    <label>
                        <input type="checkbox" name="sources" value="{{ $source }}" class="source-checkbox"
                            data-supported="{{ index $.PlaylistSupported $source }}"
                            {{ if $.Selected }}
                                {{ range $.Selected }}{{ if eq . $source }}checked{{ end }}{{ end }}
                            {{ else }}
                                {{ range $.DefaultSources }}{{ if eq . $source }}checked{{ end }}{{ end }}
                            {{ end }}> 
                        <div class="source-card">
                            <div class="source-name">{{ $source }}</div>
                            <div class="source-desc">{{ index $.SourceDescriptions $source }}</div>
                        </div>
                    </label>
                    {{ end }}
                </div>
            </div>
        </form>
    </div>

    {{ if .Playlists }}
        <div class="playlist-grid-container">
            {{ range .Playlists }}
            <a href="/playlist?id={{.ID}}&source={{.Source}}" class="playlist-card">
                <div class="playlist-cover">
                    <img src="{{ .Cover }}" loading="lazy" onerror="this.src='https://via.placeholder.com/150?text=Playlist'">
                    <span class="tag tag-src" style="position:absolute; top:5px; right:5px; margin:0;">{{ .Source }}</span>
                </div>
                <div class="playlist-meta">
                    <div class="playlist-title">{{ .Name }}</div>
                    <div class="playlist-author"><i class="fa-regular fa-user"></i> {{ .Creator }}</div>
                    <div class="playlist-count">ÂÖ± {{ .TrackCount }} È¶ñ</div>
                </div>
            </a>
            {{ end }}
        </div>
    {{ else if .Result }}
        <div class="list-header">
            <span class="result-count"><i class="fa-solid fa-music"></i> ÊâæÂà∞ <span class="count">{{ len .Result }}</span> È¶ñÊ≠åÊõ≤</span>
            <button type="button" class="ctrl-btn primary" id="btn-batch-toggle" onclick="toggleBatchMode()">
                <i class="fa-solid fa-list-check"></i> ÊâπÈáèÊìç‰Ωú
            </button>
        </div>

        <div class="batch-toolbar" id="batch-toolbar">
            <div class="batch-info">
                <div>
                    <label><input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this)"> ÂÖ®ÈÄâ</label>
                    <span style="margin-left: 5px; color: #718096; font-size:12px;">Â∑≤ÈÄâ <span id="selected-count" style="color: var(--primary-color); font-weight: bold;">0</span></span>
                </div>
                <button class="btn-pill btn-pill-warn" onclick="selectInvalidSongs()">
                    <i class="fa-solid fa-triangle-exclamation"></i> ÈÄâÊã©Êó†Êïà
                </button>
            </div>
            <div class="batch-actions">
                <button class="btn-pill btn-pill-switch" id="btn-batch-switch" onclick="batchSwitchSource()" disabled>
                    <i class="fa-solid fa-arrows-rotate"></i> ÊâπÈáèÊç¢Ê∫ê
                </button>
                <button class="btn-pill btn-pill-dl" id="btn-batch-dl" onclick="batchDownload()" disabled>
                    <i class="fa-solid fa-download"></i> ÊâπÈáè‰∏ãËΩΩ
                </button>
            </div>
        </div>

        <ul class="result-list">
            {{ range .Result }}
            <li class="song-card" 
                data-id="{{.ID}}" 
                data-source="{{.Source}}" 
                data-duration="{{.Duration}}" 
                data-name="{{.Name}}" 
                data-artist="{{.Artist}}"
                data-cover="{{.Cover}}">
                
                <div class="checkbox-wrapper">
                    <input type="checkbox" class="song-checkbox" onclick="event.stopPropagation(); updateBatchToolbar();">
                </div>

                <div class="cover-wrapper">
                    {{ if .Cover }}
                        <img src="{{ .Cover }}" alt="{{ .Name }}" loading="lazy" onerror="this.src='https://via.placeholder.com/150?text=Music'" >
                    {{ else }}
                        <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:24px;">üéµ</div>
                        <img src="https://via.placeholder.com/150?text=Music" style="display:none;">
                    {{ end }}
                </div>
                <div class="song-info">
                    <h3>{{ .Name }}</h3>
                    <div class="artist-line">
                        <i class="fa-regular fa-user" style="font-size:11px;"></i> {{ .Artist }}
                        {{ if .Album }} &nbsp;‚Ä¢&nbsp; {{ .Album }}{{ end }}
                    </div>
                    <div class="tags">
                        <span class="tag tag-src">{{ .Source }}</span>
                        {{ if .FormatDuration }}<span class="tag">{{ .FormatDuration }}</span>{{ end }}
                        <span class="tag tag-loading" id="size-{{.ID}}"><i class="fa fa-spinner fa-spin"></i></span>
                        <span class="tag tag-loading" id="bitrate-{{.ID}}"><i class="fa fa-circle-notch fa-spin"></i></span>
                    </div>
                </div>
                
                <div class="actions">
                    <button type="button" class="btn-circle btn-play" title="Êí≠Êîæ"
                            onclick="playAllAndJumpTo(this)">
                        <i class="fa-solid fa-play"></i>
                    </button>

                    <button type="button" class="btn-circle btn-switch" title="Êç¢Ê∫ê"
                            onclick="switchSource(this)">
                        <i class="fa-solid fa-arrows-rotate"></i>
                    </button>
                    
                    <a href="/download?id={{.ID}}&source={{.Source}}&name={{.Name}}&artist={{.Artist}}" 
                       id="dl-{{.ID}}" class="btn-circle btn-dl btn-download" title="‰∏ãËΩΩÊ≠åÊõ≤" target="_blank">
                        <i class="fa-solid fa-download"></i>
                    </a>

                    <a href="/download_lrc?id={{.ID}}&source={{.Source}}&name={{.Name}}&artist={{.Artist}}" 
                       id="lrc-{{.ID}}" class="btn-circle btn-dl btn-lyric" title="‰∏ãËΩΩÊ≠åËØç" target="_blank">
                        <i class="fa-solid fa-file-lines"></i>
                    </a>

                    <a href="/download_cover?url={{ .Cover }}&name={{ .Name }}&artist={{ .Artist }}" 
                       class="btn-circle btn-dl btn-cover" title="‰∏ãËΩΩÂ∞ÅÈù¢" target="_blank"
                              style="display:none;">
                        <i class="fa-regular fa-image"></i>
                    </a>
                </div>
            </li>
            {{ end }}
        </ul>
    {{ else if .Keyword }}
        {{ if not .Error }}
        <div class="no-results">
            <i class="fa-solid fa-music" style="font-size: 40px; margin-bottom: 10px; display:block;"></i>
            <p>Êú™ÊâæÂà∞Á¨¶ÂêàÊù°‰ª∂ÁöÑËµÑÊ∫ê</p>
        </div>
        {{ end }}
    {{ end }}
</div>

<div id="cookieModal" class="modal-overlay">
    <div class="modal">
        <h3 style="margin-top:0; text-align:center;">ËÆæÁΩÆ Cookies</h3>
        <div class="cookie-list">
            {{ range $source := .AllSources }}
            <div class="cookie-item">
                <label>{{ $source }}</label>
                <input type="text" id="cookie-{{$source}}" placeholder="Âú®Ê≠§Á≤òË¥¥ Cookie...">
            </div>
            {{ end }}
        </div>
        <button class="btn-save" onclick="saveCookies()">‰øùÂ≠òËÆæÁΩÆ</button>
        <div style="text-align:center; margin-top:10px; font-size:12px; color:#718096; cursor:pointer;" onclick="document.getElementById('cookieModal').style.display='none'">ÂÖ≥Èó≠</div>
    </div>
</div>

<div id="aplayer"></div>

<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<script src="https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('.source-checkbox');
        
        // ÂÖ®ÈÄâ/Ê∏ÖÁ©∫Âè™ÈíàÂØπÂΩìÂâçÂèØËßÅÔºàÊú™Á¶ÅÁî®ÔºâÁöÑÈÄâÈ°πÁîüÊïà
        document.getElementById('btn-all').onclick = () => {
            checkboxes.forEach(cb => {
                if (!cb.disabled) cb.checked = true;
            });
        };
        document.getElementById('btn-none').onclick = () => {
            checkboxes.forEach(cb => {
                if (!cb.disabled) cb.checked = false;
            });
        };

        // ÂàùÂßãÂåñÊêúÁ¥¢Á±ªÂûãÁä∂ÊÄÅ
        const initialType = document.querySelector('input[name="type"]:checked').value;
        toggleSearchType(initialType);

        // Ëá™Âä®Ê£ÄÊµã
        const cards = document.querySelectorAll('.song-card');
        cards.forEach((card, index) => {
            setTimeout(() => inspectSong(card), index * 100);
        });

        // Ê†πÊçÆÂ∞ÅÈù¢Â≠óÊÆµÊòæÁ§∫/ÈöêËóèÂ∞ÅÈù¢ÊåâÈíÆ
        cards.forEach(card => {
            const coverBtn = card.querySelector('.btn-cover');
            if (!coverBtn) return;
            const cover = card.dataset.cover || '';
            coverBtn.style.display = cover ? '' : 'none';
        });

        // È¶ñÊ¨°ËøõÂÖ•È°µÈù¢ÔºåÁªü‰∏ÄÂàùÂßãÂåñÊí≠ÊîæÊåâÈíÆÂõæÊ†á
        syncAllPlayButtons();
    });

    // ÂàáÊç¢ÊêúÁ¥¢Á±ªÂûãÔºöÂçïÊõ≤ vs Ê≠åÂçï
    function toggleSearchType(type) {
        const checkboxes = document.querySelectorAll('.source-checkbox');
        checkboxes.forEach(cb => {
            const isSupported = cb.dataset.supported === "true"; // "true" or ""
            if (type === 'playlist') {
                if (!isSupported) {
                    cb.disabled = true;
                    cb.checked = false;
                } else {
                    cb.disabled = false;
                }
            } else {
                // ÂçïÊõ≤Ê®°ÂºèÔºöÂÖ®ÈÉ®ÂêØÁî®
                cb.disabled = false;
            }
        });
    }

    // Ë∑≥ËΩ¨Âà∞ÊØèÊó•Êé®Ëçê
    function goToRecommend() {
        const supported = ['netease', 'qq', 'kugou', 'kuwo'];
        const selected = [];
        document.querySelectorAll('.source-checkbox:checked').forEach(cb => {
            if (supported.includes(cb.value)) {
                selected.push(cb.value);
            }
        });
        
        if (selected.length === 0) {
            window.location.href = '/recommend?sources=' + supported.join('&sources=');
        } else {
            window.location.href = '/recommend?sources=' + selected.join('&sources=');
        }
    }

    function inspectSong(card) {
        const id = card.dataset.id;
        const source = card.dataset.source;
        const duration = card.dataset.duration;

        fetch(`/inspect?id=${encodeURIComponent(id)}&source=${source}&duration=${duration}`)
            .then(r => r.json())
            .then(data => {
                const sizeTag = document.getElementById(`size-${id}`);
                const bitrateTag = document.getElementById(`bitrate-${id}`);

                if (data.valid) {
                    sizeTag.textContent = data.size;
                    sizeTag.className = "tag tag-success"; // ÊúâÊïàÊó∂Ê∑ªÂä†ÁªøËâ≤Á±ª
                    bitrateTag.textContent = data.bitrate;
                    bitrateTag.className = "tag";
                } else {
                    sizeTag.textContent = "Êó†Êïà";
                    sizeTag.className = "tag tag-fail";
                    bitrateTag.textContent = "-";
                    bitrateTag.className = "tag";
                }
            })
            .catch(() => {
                const el = document.getElementById(`size-${id}`);
                if(el) el.textContent = "Ê£ÄÊµãÂ§±Ë¥•";
            });
    }

    // Cookie Logic
    function openCookieModal() {
        document.getElementById('cookieModal').style.display = 'flex';
        fetch('/cookies').then(r => r.json()).then(data => {
            for (const [k, v] of Object.entries(data)) {
                const el = document.getElementById(`cookie-${k}`);
                if(el) el.value = v;
            }
        });
    }

    function saveCookies() {
        const data = {};
        document.querySelectorAll('input[id^="cookie-"]').forEach(input => {
            if (input.value) data[input.id.replace('cookie-', '')] = input.value;
        });
        fetch('/cookies', {
            method: 'POST', 
            body: JSON.stringify(data)
        }).then(() => {
            alert('‰øùÂ≠òÊàêÂäüÔºÅ');
            document.getElementById('cookieModal').style.display = 'none';
        });
    }

    // ÂõûÂà∞È°∂ÈÉ®ÂäüËÉΩ
    window.addEventListener('scroll', () => {
        const btn = document.getElementById('back-to-top');
        if (window.scrollY > 300) {
            btn.classList.add('show');
        } else {
            btn.classList.remove('show');
        }
    });

    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // APlayer Config
    const ap = new APlayer({
        container: document.getElementById('aplayer'),
        fixed: true, 
        autoplay: true, 
        theme: '#667eea',
        loop: 'all', 
        order: 'list', 
        preload: 'auto', 
        volume: 0.7, 
        listFolded: false, 
        lrcType: 3, 
        audio: []
    });

    let currentPlayingId = null;

    ap.on('listswitch', (e) => {
        const index = e.index;
        const newAudio = ap.list.audios[index];
        if (newAudio && newAudio.custom_id) {
            currentPlayingId = newAudio.custom_id;
            highlightCard(currentPlayingId);
            syncAllPlayButtons();
        }
    });

    ap.on('play', () => {
        const idx = ap?.list?.index;
        const audio = (typeof idx === 'number') ? ap.list.audios[idx] : null;
        if (audio && audio.custom_id) {
            currentPlayingId = audio.custom_id;
            highlightCard(currentPlayingId);
        }
        syncAllPlayButtons();
    });

    ap.on('pause', () => {
        syncAllPlayButtons();
    });

    ap.on('ended', () => {
        currentPlayingId = null;
        highlightCard(null);
        syncAllPlayButtons();
    });

    function highlightCard(targetId) {
        document.querySelectorAll('.song-card').forEach(c => c.classList.remove('playing-active'));
        const target = document.querySelector(`.song-card[data-id="${targetId}"]`);
        if (target) {
            target.classList.add('playing-active');
        }
    }

    function setPlayButtonState(card, isPlaying) {
        if (!card) return;
        const btn = card.querySelector('.btn-play');
        const icon = btn ? btn.querySelector('i') : null;
        if (!btn || !icon) return;

        icon.classList.remove('fa-play', 'fa-stop');
        icon.classList.add(isPlaying ? 'fa-stop' : 'fa-play');
        btn.title = isPlaying ? 'ÂÅúÊ≠¢' : 'Êí≠Êîæ';
    }

    function syncAllPlayButtons() {
        const isActuallyPlaying = ap?.audio && !ap.audio.paused;
        document.querySelectorAll('.song-card').forEach(card => {
            const id = card.dataset.id;
            const active = isActuallyPlaying && currentPlayingId && id === currentPlayingId;
            setPlayButtonState(card, active);
        });
    }

    function formatDuration(seconds) {
        const s = Number(seconds || 0);
        if (!s || s <= 0) return '-';
        const min = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
    }

    function updateCardWithSong(card, song) {
        const oldId = card.dataset.id; // [ÂÖ≥ÈîÆ] ‰øùÂ≠òÊóßIDÔºåÁî®‰∫éÊü•ÊâæÊí≠ÊîæÂô®‰∏≠ÁöÑÊ≠åÊõ≤

        card.dataset.id = song.id;
        card.dataset.source = song.source;
        card.dataset.duration = song.duration || 0;
        card.dataset.name = song.name || card.dataset.name;
        card.dataset.artist = song.artist || card.dataset.artist;
        card.dataset.cover = song.cover || '';

        const titleEl = card.querySelector('.song-info h3');
        if (titleEl) titleEl.textContent = song.name || '';

        const artistLine = card.querySelector('.artist-line');
        if (artistLine) {
            const albumText = song.album ? ` &nbsp;‚Ä¢&nbsp; ${song.album}` : '';
            artistLine.innerHTML = `<i class="fa-regular fa-user" style="font-size:11px;"></i> ${song.artist || ''}${albumText}`;
        }

        const sourceTag = card.querySelector('.tag-src');
        if (sourceTag) sourceTag.textContent = song.source;

        const tags = card.querySelectorAll('.tags .tag');
        if (tags && tags.length >= 2) {
            tags[1].textContent = formatDuration(song.duration);
        }

        const coverWrap = card.querySelector('.cover-wrapper');
        if (coverWrap) {
            let imgEl = coverWrap.querySelector('img');
            if (!imgEl) {
                imgEl = document.createElement('img');
                coverWrap.innerHTML = '';
                coverWrap.appendChild(imgEl);
            }
            imgEl.src = song.cover || 'https://via.placeholder.com/150?text=Music';
            imgEl.alt = song.name || '';
        }

        const dl = card.querySelector('.btn-download');
        if (dl) {
            dl.href = `/download?id=${encodeURIComponent(song.id)}&source=${song.source}&name=${encodeURIComponent(song.name)}&artist=${encodeURIComponent(song.artist)}`;
            dl.id = `dl-${song.id}`;
        }

        const lrc = card.querySelector('.btn-lyric');
        if (lrc) {
            lrc.href = `/download_lrc?id=${encodeURIComponent(song.id)}&source=${song.source}&name=${encodeURIComponent(song.name)}&artist=${encodeURIComponent(song.artist)}`;
            lrc.id = `lrc-${song.id}`;
        }

        const coverBtn = card.querySelector('.btn-cover');
        if (coverBtn) {
            if (song.cover) {
                coverBtn.style.display = '';
                coverBtn.href = `/download_cover?url=${encodeURIComponent(song.cover)}&name=${encodeURIComponent(song.name)}&artist=${encodeURIComponent(song.artist)}`;
            } else {
                coverBtn.style.display = 'none';
            }
        }

        const sizeTag = card.querySelector('[id^="size-"]');
        if (sizeTag) {
            sizeTag.id = `size-${song.id}`;
            sizeTag.className = 'tag tag-loading';
            sizeTag.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
        }
        const bitrateTag = card.querySelector('[id^="bitrate-"]');
        if (bitrateTag) {
            bitrateTag.id = `bitrate-${song.id}`;
            bitrateTag.className = 'tag tag-loading';
            bitrateTag.innerHTML = '<i class="fa fa-circle-notch fa-spin"></i>';
        }

        if (currentPlayingId === oldId) {
            currentPlayingId = song.id;
        }
        syncAllPlayButtons();

        inspectSong(card);

        // [Êñ∞Â¢û] Êç¢Ê∫êÂêéËá™Âä®Êõ¥Êñ∞Êí≠ÊîæÂô®ÂàóË°®‰∏≠ÁöÑÂØπÂ∫îÊ≠åÊõ≤ (‰º†ÂÖ•ÊóßID)
        syncSongToAPlayer(oldId, song);
    }

    // [Êñ∞Â¢û] ÂêåÊ≠•ÂçïÊõ≤‰ø°ÊÅØÂà∞ APlayer ÂàóË°®
    function syncSongToAPlayer(oldId, newSong) {
        if (!ap || !ap.list || !ap.list.audios) return;
        
        // Êü•ÊâæÊí≠ÊîæÂàóË°®‰∏≠ custom_id ÂåπÈÖçÁöÑÊ≠åÊõ≤ (‰ΩøÁî®ÊóßIDÊü•Êâæ)
        const index = ap.list.audios.findIndex(a => a.custom_id === oldId);
        
        if (index !== -1) {
            // Êõ¥Êñ∞ÂÖÉÊï∞ÊçÆ
            const audio = ap.list.audios[index];
            audio.name = newSong.name;
            audio.artist = newSong.artist;
            audio.cover = newSong.cover;
            audio.url = `/download?id=${encodeURIComponent(newSong.id)}&source=${newSong.source}&name=${encodeURIComponent(newSong.name)}&artist=${encodeURIComponent(newSong.artist)}`;
            audio.lrc = `/lyric?id=${encodeURIComponent(newSong.id)}&source=${newSong.source}`;
            audio.custom_id = newSong.id; // Êõ¥Êñ∞‰∏∫Êñ∞ID
            
            // Â¶ÇÊûúËøôÈ¶ñÊ≠åÂΩìÂâçÊ≠£Âú®Êí≠ÊîæÔºåÂº∫Âà∂ÈáçÊñ∞Âä†ËΩΩ
            if (ap.list.index === index) {
                // Âà©Áî® switch ÂàáÊç¢Âà∞Ëá™Â∑±ÔºåËß¶ÂèëÈáçÊñ∞Âä†ËΩΩ audio Ê∫ê
                ap.list.switch(index); 
                if (ap.audio.paused) {
                    ap.play();
                }
            }
        }
    }

    function switchSource(btn) {
        const card = btn.closest('.song-card');
        if (!card) return;

        const ds = card.dataset;
        const name = ds.name || '';
        const artist = ds.artist || '';
        const source = ds.source || '';
        if (!name || !source) return;

        btn.disabled = true;
        btn.style.opacity = '0.6';

        const duration = ds.duration || '';
        const url = `/switch_source?name=${encodeURIComponent(name)}&artist=${encodeURIComponent(artist)}&source=${encodeURIComponent(source)}&duration=${encodeURIComponent(duration)}`;
        fetch(url)
            .then(r => r.ok ? r.json() : Promise.reject())
            .then(song => {
                // Âú® UI Êõ¥Êñ∞ÂáΩÊï∞ÂÜÖÈÉ®‰ºöËá™Âä®Â§ÑÁêÜÊí≠ÊîæÂô®ÂêåÊ≠•
                updateCardWithSong(card, song);
            })
            .catch(() => {
                alert('Êç¢Ê∫êÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            })
            .finally(() => {
                btn.disabled = false;
                btn.style.opacity = '1';
            });
    }

    function playAllAndJumpTo(btn) {
        const currentCard = btn.closest('.song-card');
        const allCards = Array.from(document.querySelectorAll('.song-card'));
        const clickedIndex = allCards.indexOf(currentCard);

        if (clickedIndex === -1) return;

        const clickedId = currentCard.dataset.id;
        const isActuallyPlaying = ap?.audio && !ap.audio.paused;

        if (currentPlayingId && currentPlayingId === clickedId && isActuallyPlaying) {
            ap.pause();
            try { ap.seek(0); } catch (e) {}
            currentPlayingId = null;
            highlightCard(null);
            syncAllPlayButtons();
            return;
        }

        ap.list.clear();
        const playlist = [];

        allCards.forEach(card => {
            const ds = card.dataset;
            let coverUrl = '';
            const imgEl = card.querySelector('.cover-wrapper img');
            if (imgEl) coverUrl = imgEl.src;

            playlist.push({
                name: ds.name,
                artist: ds.artist,
                url: `/download?id=${encodeURIComponent(ds.id)}&source=${ds.source}&name=${encodeURIComponent(ds.name)}&artist=${encodeURIComponent(ds.artist)}`,
                cover: coverUrl,
                lrc: `/lyric?id=${encodeURIComponent(ds.id)}&source=${ds.source}`,
                theme: '#667eea',
                custom_id: ds.id 
            });
        });

        ap.list.add(playlist);
        ap.list.switch(clickedIndex);
        ap.play();

        currentPlayingId = clickedId;
        highlightCard(currentPlayingId);
        syncAllPlayButtons();
    }

    // ================= ÊâπÈáèÊìç‰ΩúÈÄªËæë =================

    let isBatchMode = false;

    // ÁÇπÂáªÊåâÈíÆÂç≥ÊøÄÊ¥ªÊ®°ÂºèÔºåÊó†ÈúÄÂÖàÂãæÈÄâ
    function toggleBatchMode() {
        isBatchMode = !isBatchMode;
        document.body.classList.toggle('batch-mode', isBatchMode);
        const btn = document.getElementById('btn-batch-toggle');
        const toolbar = document.getElementById('batch-toolbar');
        
        if (isBatchMode) {
            btn.innerHTML = '<i class="fa-solid fa-xmark"></i> ÈÄÄÂá∫ÊâπÈáè';
            btn.style.color = 'var(--error-color)';
            toolbar.classList.add('active'); // Á´ãÂç≥ÊòæÁ§∫
        } else {
            btn.innerHTML = '<i class="fa-solid fa-list-check"></i> ÊâπÈáèÊìç‰Ωú';
            btn.style.color = 'var(--text-sub)';
            toolbar.classList.remove('active');
            // ÈÄÄÂá∫Êó∂Ê∏ÖÁ©∫ÈÄâÊã©
            document.querySelectorAll('.song-checkbox').forEach(cb => cb.checked = false);
            updateBatchToolbar();
        }
    }

    function updateBatchToolbar() {
        const checkedBoxes = document.querySelectorAll('.song-checkbox:checked');
        const count = checkedBoxes.length;
        const selectAllCb = document.getElementById('select-all-checkbox');
        const batchSwitch = document.getElementById('btn-batch-switch');
        const batchDl = document.getElementById('btn-batch-dl');
        
        document.getElementById('selected-count').textContent = count;
        
        // Êõ¥Êñ∞ÂÖ®ÈÄâÊ°ÜÁä∂ÊÄÅ
        const allBoxes = document.querySelectorAll('.song-checkbox');
        if (allBoxes.length > 0) {
            selectAllCb.checked = (allBoxes.length === count);
        }

        // Ê†πÊçÆÊòØÂê¶ÈÄâ‰∏≠Êù•Á¶ÅÁî®/ÂêØÁî®Êìç‰ΩúÊåâÈíÆ
        if (count > 0) {
            batchSwitch.disabled = false;
            batchDl.disabled = false;
        } else {
            batchSwitch.disabled = true;
            batchDl.disabled = true;
        }
        
        // Êõ¥Êñ∞È´ò‰∫ÆÊ†∑Âºè
        document.querySelectorAll('.song-card').forEach(card => card.classList.remove('selected'));
        checkedBoxes.forEach(cb => {
            cb.closest('.song-card').classList.add('selected');
        });
    }

    function toggleSelectAll(mainCb) {
        const checkboxes = document.querySelectorAll('.song-checkbox');
        checkboxes.forEach(cb => cb.checked = mainCb.checked);
        updateBatchToolbar();
    }

    // ÈÄâÊã©Êó†ÊïàÊ≠åÊõ≤ (ÂåÖÂê´ÊèêÁ§∫)
    function selectInvalidSongs() {
        const invalidTags = document.querySelectorAll('.tag-fail');
        if (invalidTags.length === 0) {
            alert('ÂΩìÂâçÂàóË°®‰∏≠Ê≤°ÊúâÊ£ÄÊµãÂà∞Êó†ÊïàÊ≠åÊõ≤');
            return;
        }
        
        let count = 0;
        invalidTags.forEach(tag => {
            const card = tag.closest('.song-card');
            if (card) {
                const cb = card.querySelector('.song-checkbox');
                if (cb && !cb.checked) {
                    cb.checked = true;
                    count++;
                }
            }
        });
        
        if (count === 0) {
            alert('Êó†ÊïàÊ≠åÊõ≤Â∑≤ÂÖ®ÈÉ®ÈÄâ‰∏≠');
        }
        updateBatchToolbar();
    }

    function getSelectedSongs() {
        const checkedBoxes = document.querySelectorAll('.song-checkbox:checked');
        const songs = [];
        checkedBoxes.forEach(cb => {
            const card = cb.closest('.song-card');
            if (card) {
                const ds = card.dataset;
                let coverUrl = '';
                const imgEl = card.querySelector('.cover-wrapper img');
                if (imgEl) coverUrl = imgEl.src;
                
                songs.push({
                    id: ds.id,
                    source: ds.source,
                    name: ds.name,
                    artist: ds.artist,
                    url: `/download?id=${encodeURIComponent(ds.id)}&source=${ds.source}&name=${encodeURIComponent(ds.name)}&artist=${encodeURIComponent(ds.artist)}`,
                    cover: coverUrl,
                    lrc: `/lyric?id=${encodeURIComponent(ds.id)}&source=${ds.source}`,
                    theme: '#667eea',
                    custom_id: ds.id
                });
            }
        });
        return songs;
    }

    function batchDownload() {
        const songs = getSelectedSongs();
        if (songs.length === 0) return;

        if (!confirm(`ÂáÜÂ§á‰∏ãËΩΩ ${songs.length} È¶ñÊ≠åÊõ≤„ÄÇ\nÊ≥®ÊÑèÔºöÊµèËßàÂô®ÂèØËÉΩ‰ºöÊã¶Êà™Â§ö‰∏™ÂºπÁ™óÔºåËØ∑Âä°ÂøÖÂÖÅËÆ∏Êú¨Á´ôÁÇπÁöÑÂºπÁ™óÔºÅ`)) {
            return;
        }

        // Èó¥ÈöîËß¶Âèë‰∏ãËΩΩ
        songs.forEach((s, index) => {
            setTimeout(() => {
                const link = document.createElement('a');
                link.href = s.url;
                link.download = ''; 
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }, index * 800); 
        });
    }

    function batchSwitchSource() {
        const checkedBoxes = document.querySelectorAll('.song-checkbox:checked');
        if (checkedBoxes.length === 0) return;

        if (!confirm(`ÂáÜÂ§áÂØπ ${checkedBoxes.length} È¶ñÊ≠åÊõ≤ËøõË°åËá™Âä®Êç¢Ê∫ê„ÄÇ\nËøôÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥ÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖ„ÄÇ`)) {
            return;
        }

        // Èó¥ÈöîËß¶ÂèëÊç¢Ê∫ê
        checkedBoxes.forEach((cb, index) => {
            const card = cb.closest('.song-card');
            if (card) {
                const switchBtn = card.querySelector('.btn-switch');
                if (switchBtn) {
                    setTimeout(() => {
                        switchSource(switchBtn);
                    }, index * 1000); 
                }
            }
        });
    }
</script>

</body>
</html>